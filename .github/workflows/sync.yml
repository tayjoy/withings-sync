name: Sync Withings to Garmin

on:
  schedule:
    # Run every 3 hours at 15 minutes past the hour
    # Adjust this to your preference - this runs at :15 past every 3rd hour
    - cron: '15 */3 * * *'
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        poetry install --no-interaction --no-ansi
    
    - name: Create config directory
      run: mkdir -p $HOME/.config/withings-sync
    
    - name: Restore Withings token
      run: |
        echo '${{ secrets.WITHINGS_TOKEN }}' > $HOME/.withings_user.json
        chmod 600 $HOME/.withings_user.json
    
    - name: Run sync
      env:
        GARMIN_USERNAME: ${{ secrets.GARMIN_USERNAME }}
        GARMIN_PASSWORD: ${{ secrets.GARMIN_PASSWORD }}
      run: |
        poetry run withings-sync --verbose
    
    # Optional: Upload logs if sync fails
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs
        path: |
          $HOME/.withings_user.json
          $HOME/.garmin_session
        retention-days: 7
